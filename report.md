# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Reentrancy: State change after external call](#h-1-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Unsafe ERC20 Operation](#l-2-unsafe-erc20-operation)
  - [L-3: Literal Instead of Constant](#l-3-literal-instead-of-constant)
  - [L-4: Large Numeric Literal](#l-4-large-numeric-literal)
  - [L-5: Local Variable Shadows State Variable](#l-5-local-variable-shadows-state-variable)
  - [L-6: Unused Import](#l-6-unused-import)
  - [L-7: Unchecked Return](#l-7-unchecked-return)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 4 |
| Total nSLOC | 299 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/interfaces/ILeverageVault.sol | 6 |
| src/interfaces/ISwapRouterV3.sol | 14 |
| src/interfaces/IWETH.sol | 5 |
| src/vaults/LeverageVault.sol | 274 |
| **Total** | **299** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 1 |
| Low | 7 |


# High Issues

## H-1: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>1 Found Instances</summary>


- Found in src/vaults/LeverageVault.sol [Line: 91](src/vaults/LeverageVault.sol#L91)

	State is changed at: `debtDecimals = ERC20(_dToken).decimals()`
	```solidity
	        assetDecimals = ERC20(asset()).decimals();
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>2 Found Instances</summary>


- Found in src/vaults/LeverageVault.sol [Line: 23](src/vaults/LeverageVault.sol#L23)

	```solidity
	contract LeverageVault is ERC4626, Ownable, IFlashLoan, ReentrancyGuard {
	```

- Found in src/vaults/LeverageVault.sol [Line: 429](src/vaults/LeverageVault.sol#L429)

	```solidity
	    function rebalance() external onlyOwner {
	```

</details>



## L-2: Unsafe ERC20 Operation

ERC20 functions may not behave as expected. For example: return values are not always meaningful. It is recommended to use OpenZeppelin's SafeERC20 library.

<details><summary>8 Found Instances</summary>


- Found in src/vaults/LeverageVault.sol [Line: 165](src/vaults/LeverageVault.sol#L165)

	```solidity
	            dToken.approve(address(swapRouter), delta);
	```

- Found in src/vaults/LeverageVault.sol [Line: 185](src/vaults/LeverageVault.sol#L185)

	```solidity
	            IERC20(asset()).approve(address(cEVault), boughtCollateral);
	```

- Found in src/vaults/LeverageVault.sol [Line: 194](src/vaults/LeverageVault.sol#L194)

	```solidity
	            dToken.approve(address(dEVault), delta);
	```

- Found in src/vaults/LeverageVault.sol [Line: 206](src/vaults/LeverageVault.sol#L206)

	```solidity
	            IERC20(asset()).approve(address(swapRouter), collateralForLoan);
	```

- Found in src/vaults/LeverageVault.sol [Line: 231](src/vaults/LeverageVault.sol#L231)

	```solidity
	                    dToken.approve(address(dEVault), toRepay);
	```

- Found in src/vaults/LeverageVault.sol [Line: 265](src/vaults/LeverageVault.sol#L265)

	```solidity
	        IERC20(asset()).approve(address(swapRouter), collateralToWithdraw);
	```

- Found in src/vaults/LeverageVault.sol [Line: 292](src/vaults/LeverageVault.sol#L292)

	```solidity
	        dToken.approve(address(dEVault), repayAmount);
	```

- Found in src/vaults/LeverageVault.sol [Line: 336](src/vaults/LeverageVault.sol#L336)

	```solidity
	        IERC20(asset()).approve(address(cEVault), assets);
	```

</details>



## L-3: Literal Instead of Constant

Define and use `constant` variables instead of using literals. If the same constant literal value is used multiple times, create a constant state variable and reference it throughout the contract.

<details><summary>16 Found Instances</summary>


- Found in src/vaults/LeverageVault.sol [Line: 106](src/vaults/LeverageVault.sol#L106)

	```solidity
	        s.assetsValue = (s.collateral * s.collateralPrice) / (10 ** ERC20(asset()).decimals());
	```

- Found in src/vaults/LeverageVault.sol [Line: 118](src/vaults/LeverageVault.sol#L118)

	```solidity
	        s.leverage = (s.equityValue != 0) ? ((s.assetsValue * 1e18) / s.equityValue) : 0;
	```

- Found in src/vaults/LeverageVault.sol [Line: 130](src/vaults/LeverageVault.sol#L130)

	```solidity
	        uint256 targetAssetsValue = (targetLeverage * s.equityValue) / 1e18;
	```

- Found in src/vaults/LeverageVault.sol [Line: 171](src/vaults/LeverageVault.sol#L171)

	```solidity
	            uint256 expectedCollateral = Math.mulDiv(delta, 10 ** assetDecimals, price);
	```

- Found in src/vaults/LeverageVault.sol [Line: 200](src/vaults/LeverageVault.sol#L200)

	```solidity
	            uint256 collateralForLoan = Math.mulDiv(delta, 10 ** assetDecimals, price, Math.Rounding.Ceil);
	```

- Found in src/vaults/LeverageVault.sol [Line: 256](src/vaults/LeverageVault.sol#L256)

	```solidity
	        uint256 collateralToWithdraw = (delta * (10 ** ERC20(asset()).decimals())) / s.collateralPrice;
	```

- Found in src/vaults/LeverageVault.sol [Line: 269](src/vaults/LeverageVault.sol#L269)

	```solidity
	        uint256 expectedDebt = Math.mulDiv(collateralToWithdraw, price, 10 ** assetDecimals);
	```

- Found in src/vaults/LeverageVault.sol [Line: 270](src/vaults/LeverageVault.sol#L270)

	```solidity
	        uint256 minDebt = (expectedDebt * (10000 - MAX_SLIPPAGE_BPS)) / 10000;
	```

- Found in src/vaults/LeverageVault.sol [Line: 316](src/vaults/LeverageVault.sol#L316)

	```solidity
	        uint256 priceAssetInUoA = IPriceOracle(oracle).getQuote(1e18, asset(), uoa);
	```

- Found in src/vaults/LeverageVault.sol [Line: 319](src/vaults/LeverageVault.sol#L319)

	```solidity
	        uint256 priceDebtInUoA = IPriceOracle(oracle).getQuote(1e18, address(dToken), uoa);
	```

- Found in src/vaults/LeverageVault.sol [Line: 322](src/vaults/LeverageVault.sol#L322)

	```solidity
	        uint256 ratio = (priceAssetInUoA * 1e18) / priceDebtInUoA;
	```

- Found in src/vaults/LeverageVault.sol [Line: 324](src/vaults/LeverageVault.sol#L324)

	```solidity
	        uint256 priceCInDebt = (ratio * (10 ** debtDecimals)) / 1e18;
	```

- Found in src/vaults/LeverageVault.sol [Line: 415](src/vaults/LeverageVault.sol#L415)

	```solidity
	        uint256 assetsValue = (collateral * collateralPrice) / (10 ** assetDecimals);
	```

- Found in src/vaults/LeverageVault.sol [Line: 424](src/vaults/LeverageVault.sol#L424)

	```solidity
	        uint256 eInC = (equityValue * (10 ** assetDecimals)) / collateralPrice;
	```

</details>



## L-4: Large Numeric Literal

Large literal values multiples of 10000 can be replaced with scientific notation.Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>2 Found Instances</summary>


- Found in src/vaults/LeverageVault.sol [Line: 270](src/vaults/LeverageVault.sol#L270)

	```solidity
	        uint256 minDebt = (expectedDebt * (10000 - MAX_SLIPPAGE_BPS)) / 10000;
	```

</details>



## L-5: Local Variable Shadows State Variable

Rename the local variable that shadows another state variable.

<details><summary>2 Found Instances</summary>


- Found in src/vaults/LeverageVault.sol [Line: 70](src/vaults/LeverageVault.sol#L70)

	```solidity
	        string memory _name,
	```

- Found in src/vaults/LeverageVault.sol [Line: 71](src/vaults/LeverageVault.sol#L71)

	```solidity
	        string memory _symbol,
	```

</details>



## L-6: Unused Import

Redundant import statement. Consider removing it.

<details><summary>3 Found Instances</summary>


- Found in src/interfaces/ILeverageVault.sol [Line: 4](src/interfaces/ILeverageVault.sol#L4)

	```solidity
	import {IERC4626} from "@openzeppelin/contracts/interfaces/IERC4626.sol";
	```

- Found in src/vaults/LeverageVault.sol [Line: 12](src/vaults/LeverageVault.sol#L12)

	```solidity
	import {ILeverageVault} from "../interfaces/ILeverageVault.sol";
	```

- Found in src/vaults/LeverageVault.sol [Line: 21](src/vaults/LeverageVault.sol#L21)

	```solidity
	import "forge-std/console2.sol";
	```

</details>



## L-7: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>16 Found Instances</summary>


- Found in src/vaults/LeverageVault.sol [Line: 165](src/vaults/LeverageVault.sol#L165)

	```solidity
	            dToken.approve(address(swapRouter), delta);
	```

- Found in src/vaults/LeverageVault.sol [Line: 185](src/vaults/LeverageVault.sol#L185)

	```solidity
	            IERC20(asset()).approve(address(cEVault), boughtCollateral);
	```

- Found in src/vaults/LeverageVault.sol [Line: 186](src/vaults/LeverageVault.sol#L186)

	```solidity
	            cEVault.deposit(boughtCollateral, address(this));
	```

- Found in src/vaults/LeverageVault.sol [Line: 194](src/vaults/LeverageVault.sol#L194)

	```solidity
	            dToken.approve(address(dEVault), delta);
	```

- Found in src/vaults/LeverageVault.sol [Line: 195](src/vaults/LeverageVault.sol#L195)

	```solidity
	            dEVault.repay(delta, address(this));
	```

- Found in src/vaults/LeverageVault.sol [Line: 203](src/vaults/LeverageVault.sol#L203)

	```solidity
	            cEVault.withdraw(collateralForLoan, address(this), address(this));
	```

- Found in src/vaults/LeverageVault.sol [Line: 206](src/vaults/LeverageVault.sol#L206)

	```solidity
	            IERC20(asset()).approve(address(swapRouter), collateralForLoan);
	```

- Found in src/vaults/LeverageVault.sol [Line: 231](src/vaults/LeverageVault.sol#L231)

	```solidity
	                    dToken.approve(address(dEVault), toRepay);
	```

- Found in src/vaults/LeverageVault.sol [Line: 232](src/vaults/LeverageVault.sol#L232)

	```solidity
	                    dEVault.repay(toRepay, address(this));
	```

- Found in src/vaults/LeverageVault.sol [Line: 262](src/vaults/LeverageVault.sol#L262)

	```solidity
	        cEVault.withdraw(collateralToWithdraw, address(this), address(this));
	```

- Found in src/vaults/LeverageVault.sol [Line: 265](src/vaults/LeverageVault.sol#L265)

	```solidity
	        IERC20(asset()).approve(address(swapRouter), collateralToWithdraw);
	```

- Found in src/vaults/LeverageVault.sol [Line: 292](src/vaults/LeverageVault.sol#L292)

	```solidity
	        dToken.approve(address(dEVault), repayAmount);
	```

- Found in src/vaults/LeverageVault.sol [Line: 293](src/vaults/LeverageVault.sol#L293)

	```solidity
	        dEVault.repay(repayAmount, address(this));
	```

- Found in src/vaults/LeverageVault.sol [Line: 336](src/vaults/LeverageVault.sol#L336)

	```solidity
	        IERC20(asset()).approve(address(cEVault), assets);
	```

- Found in src/vaults/LeverageVault.sol [Line: 337](src/vaults/LeverageVault.sol#L337)

	```solidity
	        cEVault.deposit(assets, address(this));
	```

- Found in src/vaults/LeverageVault.sol [Line: 394](src/vaults/LeverageVault.sol#L394)

	```solidity
	            cEVault.withdraw(assets, address(this), address(this));
	```

</details>



